<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイページ | Akagami Prompt</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      body { font-family: 'M PLUS Rounded 1c', sans-serif; }
      :root { --accent-color: #E94B6F; }
      .accent-bg { background-color: var(--accent-color); }
      .accent-text { color: var(--accent-color); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="accent-bg text-white py-6 shadow-md">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">
                    <i class="fas fa-user-circle mr-2"></i>マイページ
                </h1>
                <a href="/" class="text-white hover:opacity-80 transition">
                    <i class="fas fa-home mr-2"></i>トップへ
                </a>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto p-4 py-8">
        <!-- User Info Card -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-user mr-2 accent-text"></i>ユーザー情報
            </h2>
            <div id="user-info" class="mb-6">
                <p class="text-gray-600">読み込み中...</p>
            </div>
            <button onclick="logout()" class="accent-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
            </button>
        </div>

        <!-- Submissions Card -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-images mr-2 accent-text"></i>投稿履歴
            </h2>
            <div id="submissions-list">
                <p class="text-gray-600">読み込み中...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        async function checkAuth() {
            try {
                const response = await axios.get('/api/auth/me');
                const user = response.data.user;
                document.getElementById('user-info').innerHTML = `
                    <div class="space-y-2">
                        <p class="text-lg"><strong>ニックネーム:</strong> ${user.nickname}</p>
                        <p class="text-sm text-gray-600"><strong>メールアドレス:</strong> ${user.email}</p>
                    </div>
                `;
                loadSubmissions();
            } catch (error) {
                alert('ログインしてください');
                window.location.href = '/login.html';
            }
        }

        async function loadSubmissions() {
            try {
                const response = await axios.get('/api/submissions/my');
                const submissions = response.data;

                if (submissions.length === 0) {
                    document.getElementById('submissions-list').innerHTML = '<p class="text-gray-500 text-center py-8">まだ投稿がありません</p>';
                    return;
                }

                document.getElementById('submissions-list').innerHTML = submissions.map(sub => `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:border-gray-300 transition">
                        <div class="flex items-center gap-4">
                            <img src="${sub.image_url}" class="w-32 h-32 object-cover rounded-lg shadow">
                            <div class="flex-1">
                                <a href="/prompt/${sub.prompt_id}" class="text-blue-600 hover:underline font-semibold block mb-2">
                                    <i class="fas fa-link mr-1"></i>${sub.prompt_title}
                                </a>
                                <p class="text-sm text-gray-500 mb-2">
                                    <i class="fas fa-clock mr-1"></i>${new Date(sub.created_at).toLocaleString('ja-JP')}
                                </p>
                                <p class="text-sm mb-3">
                                    ${sub.is_approved 
                                        ? '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>承認済み</span>' 
                                        : '<span class="text-yellow-600"><i class="fas fa-clock mr-1"></i>承認待ち</span>'
                                    }
                                </p>
                                <button onclick="deleteSubmission(${sub.id})" class="text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-trash mr-1"></i>削除
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error(error);
                document.getElementById('submissions-list').innerHTML = '<p class="text-red-500 text-center py-8">投稿の取得に失敗しました</p>';
            }
        }

        async function deleteSubmission(id) {
            if (!confirm('この投稿を削除しますか？')) return;

            try {
                await axios.delete(`/api/submissions/${id}`);
                alert('削除しました');
                loadSubmissions();
            } catch (error) {
                alert('削除に失敗しました');
            }
        }

        async function logout() {
            if (!confirm('ログアウトしますか？')) return;

            try {
                await axios.post('/api/auth/logout');
                alert('ログアウトしました');
                window.location.href = '/';
            } catch (error) {
                console.error(error);
            }
        }

        checkAuth();
    </script>
</body>
</html>
